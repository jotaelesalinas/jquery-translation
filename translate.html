<script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
<script>
String.prototype.trim = function () {
	return this.replace(/^\s+|\s+$/, '');
};

// dummy console
if (typeof window.console.log === 'undefined') {
	window.console.log = function (text) {
		// do nothing
	};
}

if( typeof Array.isArray !== 'function' ) {
    Array.isArray = function( arr ) {
        return Object.prototype.toString.call( arr ) === '[object Array]';
    };
}

// localstorage
if ( typeof ls_exists === 'undefined' ) {

	// internal stuff
	
	if ( typeof window.localStorage === 'undefined' ) {
		window.localStorage =  {};
		console.log('Warning: localstorage not available. Using dummy variable instead.');
	}
	
	function _ls_check_exists (name) {
		if ( ! ls_exists (name) ) {
			throw "Variable '" + name + "' does not exist in localstorage.";
		}
		return true;
	}
	
	function _ls_check_object (name) {
		var item = ls_read(name);
		if ( typeof item !== 'object' ) {
			throw "Variable '" + name + "' in localstorage is not an object.";
		} else if ( Array.isArray(item) ) {
			throw "Variable '" + name + "' in localstorage is not an object.";
		}
		return item;
	}
	
	function _ls_check_array (name) {
		var item = ls_read(name);
		if ( typeof item !== 'object' ) {
			throw "Variable '" + name + "' in localstorage is not an array.";
		} else if ( ! Array.isArray(item) ) {
			throw "Variable '" + name + "' in localstorage is not an array.";
		}
		return item;
	}
	
	// basic operations
	
	function ls_exists (name) {
		return (typeof window.localStorage[name] !== 'undefined') && (window.localStorage[name] !== null);
	}
	function ls_read (name) {
		_ls_check_exists(name);
		return JSON.parse(window.localStorage[name]);
	}
	function ls_write (name, value) {
		window.localStorage[name] = JSON.stringify(value);
	}
	function ls_delete (name) {
			window.localStorage[name] = null;
	}
	
	// operations for objects (associative arrays)
	
	function ls_obj_has(name, key) {
		var item = _ls_check_object(name);
		return (typeof item[key] !== 'undefined') && (item[key] !== null);
	}
	function ls_obj_get(name, key) {
		var item = _ls_check_object(name);
		return typeof item[key] !== 'undefined' ? item[key] : null;
	}
	function ls_obj_set(name, key, value) {
		var item = _ls_check_object(name);
		item[key] = value;
		ls_write(name, item);
	}
	function ls_obj_del(name, key) {
		ls_obj_set(name, key, null);
	}
	function ls_obj_keys (name) {
		var item = _ls_check_object(name);
		if (typeof Object.keys !== 'undefined') {
			return Object.keys(item);
		}
		var keys = [];
		for (var i in item) {
			keys.push(i);
		}
		return keys;
	}
	function ls_obj_each (name, callback) {
		var item = _ls_check_object(name);
		var indices = ls_obj_keys(name);
		for (var i = 0; i < indices.length; i++) {
			callback(i, item[i]);
		}
	}
	function ls_obj_length (name) {
		return ls_obj_keys(name).length;
	}
	
	// operations for real arrays (numeric arrays)
	
	function ls_arr_length (name) {
		var item = _ls_check_array(name);
		return item.length;
	}
	function ls_arr_has(name, key) {
		var item = _ls_check_array(name);
		return (typeof item[key] !== 'undefined') && (item[key] !== null);
	}
	function ls_arr_get(name, key) {
		var item = _ls_check_array(name);
		return typeof item[key] !== 'undefined' ? item[key] : null;
	}
	function ls_arr_set(name, key, value) {
		var item = _ls_check_array(name);
		item[key] = value;
		ls_write(name, item);
	}
	function ls_arr_del(name, key) {
		ls_arr_set(name, key, null);
	}
	function ls_arr_push(name, value) {
		var item = _ls_check_array(name);
		item.push(value);
		ls_write(name, item);
	}
	function ls_arr_pop(name) {
		var item = _ls_check_array(name);
		var ret = item.pop();
		ls_write(name, item);
		return ret;
	}
	function ls_arr_each (name, callback) {
		var item = _ls_check_array(name);
		for (var i = 0; i < item.length; i++) {
			callback(i, item[i]);
		}
	}
}


/*
 * translate
 * Automatic translation plugin for jQuery
 * 
 * options:
 *  - lang: destination language
 *  - url: json provider for missing translations
 *  - trans: 
 * Copyright 2011 Jose L. Salinas
 * Released under the MIT License
*/

(function($){
	
	// interaction with localstorage
	
	if (! ls_exists('trans')) {
		ls_write('trans', {});
	}
	
	var set_trans = function (lang, key, value) {
		if (typeof key === 'string') {
			key = lang + '|' + key;
			ls_obj_set('trans', key, value);
		} else {
			for (var i in key) {
				set_trans(lang, i, key[i]);
			}
		}
	};
	
	var get_trans = function (lang, key) {
		if ( (typeof key === 'undefined') || (key === null) ) {
			var _trans = {};
			
			var keys = ls_obj_keys('trans');
			for (var i = 0; i < keys.length; i++) {
				var parts = keys[i].split('|');
				if (parts.length < 2) {
					continue;
				} else if (parts.length > 2) {
					throw "Error: keys for translations cannot contain '|'.";
				}
				var k = parts[1];
				if (parts[0] == lang) {
					_trans[k] = get_trans(lang, k);
				}
			}
			
			return _trans;
		}
		
		key = lang + '|' + key;
		return ls_obj_get('trans', key);
	};
	
	$.fn.translate = function(options) {
		
		const DATA_STR_ID       = 'trans_id',
		      DATA_PARAM_PREFIX = 'param_',
			  CLASS_NO_TRANS    = 'trans-not-found',
			  CLASS_NO_PARAM    = 'trans-missing-param';
		
		// interaction with HTML DOM
		
		var extract_strids = function () {
			plugin.each( function () {
				var strid = $(this).data(DATA_STR_ID).trim();
				if ( strid !== '' ) {
					if ( (get_trans(settings.lang, strid) === null) ||
					     (get_trans(settings.lang, strid) == strid) ) {
						set_trans(settings.lang, strid, false);
					}
				}
			} );
		};
		
		var do_translation = function () {
			plugin.each( function () {
				// XXX check data-strid
				var strid = $(this).data(DATA_STR_ID);
				if ( strid === '' ) {
					return;
				}
				
				var text = get_trans(settings.lang, strid);
				
				var re = /\[_(\w+)_\]/g;
				var params = [],
				    full_params = [];
				while (match = re.exec(text)) {
					full_params.push(match[0]);
					params.push(match[1]);
				}
				
				for (var i = 0; i < params.length; i++) {
					var p = params[i],
					    full_p = full_params[i];
					
					var key = DATA_PARAM_PREFIX + p.toLowerCase();
					var value = $(this).data(key);
					if ( (typeof value === 'undefined') || (value === null) ) {
						value = '';
						console.log("Warning: missing parameter '" + full_p + "' in translation string '" + strid + "'");
						$(this).addClass(CLASS_NO_PARAM);
					}
					
					text = text.replace(full_p, value);
				}
				
				$(this).html( text );
			} );
		};
		
		// translation fetching
		
		var get_translations = function () {
			var ids = [];
			
			var trans = get_trans(settings.lang);
			
			for(strid in trans) {
				var text = trans[strid];
				if ( text === false ) {
					if (ids.length >= settings.items_per_request) {
						return;
					}
					ids.push(strid);
				}
			}

			if ( ids.length > 0 ) {
				var url = (typeof settings.url !== 'undefined') ? settings.url : '';
				
				if (!url) {
					if ( typeof window.console !== 'undefined' ) {
						console.log('Warning: missing translate plugin option "url"');
						// return;
					}
					for (var i = 0; i < ids.length; i++) {
						set_trans(settings.lang, ids[i], ids[i]);
						console.log('Warning: no translation for "' + ids[i] + '" (lang: ' + settings.lang + ')');
						$('[data-' + DATA_STR_ID + '=' + ids[i] + ']').addClass(CLASS_NO_TRANS);
					}
					get_translations();
				} else {
					url = url.replace('[_TRANS_IDS_]', ids.join(','))
					         .replace('[_LANG_]', settings.lang);
					$.getJSON( url, function (data) {
						for (var i = 0; i < ids.length; i++) {
							if ( (typeof data[ids[i]] === 'undefined') || (data[ids[i]] === null) ) {
								set_trans(settings.lang, ids[i], ids[i]);
								if ( typeof window.console !== 'undefined' ) {
									console.log('Warning: no translation for "' + ids[i] + '" (lang: ' + settings.lang + ')');
									$('[data-' + DATA_STR_ID + '=' + ids[i] + ']').addClass(CLASS_NO_TRANS);
								}
							} else {
								set_trans(settings.lang, ids[i], data[ids[i]]);
							}
						}
						get_translations();
					} );
				}
			} else {
				do_translation();
			}
		};
		
		// initialization
		
		var plugin = this;
		
		var settings = $.extend({}, $.fn.translate.defaults, options);
		
		extract_strids();
		get_translations();
		
		return plugin.each(function(){});
		
	};
	
	$.fn.translate.defaults = {
		"trans_table"       : {},
		"lang"              : '',
		"localstorage"      : false,
		"url"               : '',
		"items_per_request" : 25
	};
	
	$.fn.translate.addTrans = function (lang, transTable) {
		for (key in transTable) {
			set_trans(lang, key, transTable[key]);
		}
	};
	
})(jQuery);
</script>

<style>
span.trans.trans-not-found {
	background-color:#eee;
	color:red;
	font-weight:bold;
	padding: .25em;
}
span.trans.trans-missing-param {
	background-color:#eee;
	color:orange;
	font-weight:bold;
	padding: .25em;
}
</style>

<div>
	<p><span class="trans" data-trans_id="_welcome_to" data-param_place="Madrid"></span></p>
	<p><span class="trans" data-trans_id="_hello" data-param_treatment="Sr." data-param_last_name="García"></span></p>
	<p><span class="trans" data-trans_id="_goodbye"></span></p>
</div>

<script>
	
	var url = 'http://www.wolford.com/testing/shop2/trans.php?lang=[_LANG_]&strids=[_TRANS_IDS_]&format=jsonp&callback=?';
	$('.trans').translate.addTrans( 'es', { "_welcome_to": '¡Bienvenidos a [_PLACE_]!', "_hello": 'Hola, [_TREATMENT_] [_LAST_NAME_].', "_goodbye": 'Adiós.' } );
	$('.trans').translate( { "lang": 'es' } );
</script>
